<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حسابي - المحفظة الرقمية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0d6efd; --background-gradient: linear-gradient(to top, #f2f4f6 0%, #ffffff 100%); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); --border-radius: 12px; }
        body { font-family: 'Cairo', sans-serif; background: var(--background-gradient); padding-bottom: 80px; }
        .main-content, .auth-container { display: none; }
        .active-section { display: block; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .auth-container { max-width: 450px; margin: 5rem auto; }
        .auth-container .card { border: none; border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
        .page-header { font-weight: 700; color: #333; margin-bottom: 1.5rem; }
        .content-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); border: 1px solid #e9ecef; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: #ffffff; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 1000; border-top: 1px solid #f0f0f0; }
        .nav-item { flex-basis: 0; flex-grow: 1; display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; transition: all 0.3s ease; }
        .nav-item i { font-size: 1.5rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); }
        .card-digital { color: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; transition: all 0.5s ease; }
        .card-digital.default-card { background: linear-gradient(to right, #8f94fb, #4e54c8); }
        .card-digital.vip-card { background: linear-gradient(to right, #243B55, #141E30); }
        .card-header-flex { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-header-logo { font-size: 1.2rem; font-weight: bold; }
        .card-profile-pic { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); object-fit: cover; background-color: rgba(255,255,255,0.2); }
        .card-placeholder-icon { font-size: 60px; color: rgba(255,255,255,0.5); }
        .card-username { font-size: 1.8rem; font-weight: 700; margin-top: 15px; }
        .card-uid { font-family: monospace; letter-spacing: 2px; font-size: 0.8rem; color: #bdc3c7; opacity: 0.8; }
        .card-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; text-align: right; }
        .card-balance .label { font-size: 0.9rem; color: #ecf0f1; opacity: 0.8; }
        .card-balance .amount { font-size: 1.7rem; font-weight: 700; }
        .transaction-note { font-style: italic; color: #6c757d; font-size: 0.85rem; }
        .process-step { display: none; }
        #certificate, #deposit-invoice { border: 2px solid #333; background: #fdfdfd; padding: 1.5rem; color: #000; }
        .instructions { list-style-type: none; padding-right: 0; }
        .instructions li { margin-bottom: 0.5rem; }
        .instructions li .num { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background-color: #333; color: #fff; font-size: 0.8rem; margin-left: 0.5rem; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1080; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="auth-section" class="auth-container"><div class="card p-4"><h3 class="text-center mb-4" id="auth-title">تسجيل الدخول</h3><form id="login-form"><div class="mb-3"><label for="login-email" class="form-label">البريد الإلكتروني</label><input type="email" class="form-control" id="login-email" required></div><div class="mb-3"><label for="login-password" class="form-label">كلمة المرور</label><input type="password" class="form-control" id="login-password" required></div><button type="submit" class="btn btn-primary w-100">دخول</button></form><form id="register-form" class="d-none"><div class="mb-3"><label for="register-username" class="form-label">اسم المستخدم</label><input type="text" class="form-control" id="register-username" required></div><div class="mb-3"><label for="register-email" class="form-label">البريد الإلكتروني</label><input type="email" class="form-control" id="register-email" required></div><div class="mb-3"><label for="register-password" class="form-label">كلمة المرور</label><input type="password" class="form-control" id="register-password" minlength="6" required></div><button type="submit" class="btn btn-success w-100">إنشاء حساب</button></form><div id="auth-error" class="alert alert-danger mt-3 d-none"></div><p class="text-center mt-3 mb-0"><a href="#" id="switch-auth-mode">ليس لديك حساب؟ إنشاء حساب جديد</a></p></div></div>
    <div id="main-section" class="main-content">
        <div class="container mt-4">
            <div id="profile" class="page"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="page-header mb-0">الحساب الشخصي</h3><span id="profile-status" class="badge fs-6"></span></div><div class="content-card mb-3"><div class="card-body"><ul class="list-group list-group-flush"><li class="list-group-item"><strong>اسم المستخدم:</strong> <span id="profile-username"></span></li><li class="list-group-item"><strong>UID:</strong> <code id="profile-uid" class="text-muted" title="اضغط للنسخ"></code></li></ul></div></div><div id="vip-section" class="content-card"></div></div>
            <div id="wallet" class="page">
                <h3 class="page-header">المحفظة</h3>
                <div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title"><i class="bi bi-coin"></i> رصيد الروبل</h5><p class="card-text fs-1 fw-bold" id="wallet-roble">0</p></div></div>
                <div class="row g-2 mb-4">
                    <div class="col-6 d-grid"><button class="btn btn-success btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#sendModal"><i class="bi bi-arrow-up-right-circle"></i> إرسال</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-primary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#requestModal"><i class="bi bi-qr-code"></i> طلب</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-info text-white btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#depositModal"><i class="bi bi-arrow-down-left-circle"></i> إيداع</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-secondary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#withdrawModal"><i class="bi bi-arrow-repeat"></i> سحب</button></div>
                </div>
                <div class="content-card mb-4"><div class="card-body"><h5 class="card-title">استرداد كود هدية</h5><form id="redeem-code-form" class="d-flex"><input type="text" id="redeem-code-input" class="form-control me-2" placeholder="أدخل الكود هنا" required><button class="btn btn-warning" type="submit">استرداد</button></form></div></div>
                <div class="content-card"><div class="card-header bg-white"><h5><i class="bi bi-list-ul"></i> سجل العمليات</h5></div><div class="card-body p-0"><ul id="transaction-history" class="list-group list-group-flush"></ul></div></div>
            </div>
            <div id="leaderboard" class="page"><h3 class="page-header">🏆 لوحة الصدارة</h3><div class="content-card"><div class="card-body"><ol id="leaderboard-list" class="list-group list-group-numbered"></ol></div></div></div>
            <div id="card" class="page"><h3 class="page-header">البطاقة الرقمية</h3><div id="digital-card-container" class="card-digital default-card mb-3"></div><div class="content-card mb-3"><div class="card-body"><label for="image-upload" class="form-label">تغيير صورة البطاقة</label><input class="form-control" type="file" id="image-upload" accept="image/*"></div></div><button id="download-card-btn" class="btn btn-success w-100"><i class="bi bi-download"></i> تحميل البطاقة كصورة</button></div>
        </div>
        <nav class="bottom-nav"><a href="#" class="nav-item" data-page="profile"><i class="bi bi-person-fill"></i><span>الحساب</span></a><a href="#" class="nav-item" data-page="wallet"><i class="bi bi-wallet-fill"></i><span>المحفظة</span></a><a href="#" class="nav-item" data-page="leaderboard"><i class="bi bi-trophy-fill"></i><span>الصدارة</span></a><a href="#" class="nav-item" data-page="card"><i class="bi bi-credit-card-2-front-fill"></i><span>البطاقة</span></a></nav>
    </div>
    <div class="modal fade" id="sendModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إرسال روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-pills nav-fill mb-3" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-id">عبر ID</button></li><li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-qr">مسح QR</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="pills-id"><form id="send-by-id-form"><div class="mb-3"><label class="form-label">UID المستلم</label><input type="text" class="form-control" id="recipient-uid" required></div><div class="mb-3"><label class="form-label">المبلغ</label><input type="number" class="form-control" id="transfer-amount" min="1" required></div><div class="mb-3"><label class="form-label">ملاحظة (اختياري)</label><input type="text" class="form-control" id="transfer-note" placeholder="مثال: شكراً لك"></div><button type="submit" class="btn btn-primary w-100">تأكيد</button></form></div><div class="tab-pane fade" id="pills-qr"><div id="qr-reader" style="width:100%; border-radius:12px; border:2px dashed #ccc; overflow:hidden;"></div><hr><input type="file" id="qr-file-input" class="d-none" accept="image/*"><label for="qr-file-input" class="btn btn-secondary w-100"><i class="bi bi-image"></i> اختر صورة QR</label></div></div></div></div></div></div>
    <div class="modal fade" id="requestModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">طلب روبل عبر QR</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">المبلغ المطلوب</label><input type="number" class="form-control" id="request-amount" min="1"></div><button id="generate-qr-btn" class="btn btn-primary w-100 mb-3">إنشاء كود</button><div id="qrcode-container" style="display:flex; justify-content:center; align-items:center; padding:1rem; border:1px solid #eee; border-radius:12px; min-height:280px;"><span class="text-muted">سيظهر كود QR هنا</span></div></div></div></div></div>
    <div class="modal fade" id="confirmTransferModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mt-2">هل أنت متأكد من إرسال روبل إلى:</h5><h3 class="mb-1" id="confirm-recipient-name">...</h3><hr><p class="text-muted mb-1">المبلغ</p><p class="fs-3 fw-bold" id="confirm-amount">0</p><p class="text-muted mb-1" id="confirm-tax-label">الضريبة</p><p class="fs-5" id="confirm-tax-amount">0</p><p class="text-muted mb-1">الإجمالي المخصوم</p><p class="fs-4 fw-bold" id="confirm-total-deducted">0</p><div class="my-3"><label class="form-label">إضافة ملاحظة (اختياري)</label><input type="text" class="form-control" id="confirmation-note"></div><div class="d-grid gap-2 mt-4"><button type="button" class="btn btn-primary btn-lg" id="confirm-transfer-btn">نعم، أوافق</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">رفض</button></div></div></div></div></div>
    <div class="modal fade" id="withdrawModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">طلب سحب روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="withdraw-step-1" class="process-step"><div class="mb-3"><label for="withdraw-amount" class="form-label">المبلغ المراد سحبه</label><input type="number" class="form-control" id="withdraw-amount" min="1"></div><div class="mb-3"><label class="form-label">السحب مقابل</label><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeGold" value="gold" checked><label class="form-check-label" for="typeGold">غولد</label></div><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeBank" value="bank"><label class="form-check-label" for="typeBank">أموال حقيقية</label></div></div><button id="withdraw-next-btn" class="btn btn-primary w-100">التالي</button></div><div id="withdraw-step-2" class="process-step"><div id="bank-card-input-group" class="mb-3 d-none"><label for="user-bank-card" class="form-label">أدخل رقم بطاقتك لاستلام المبلغ</label><input type="text" class="form-control" id="user-bank-card"></div><button id="generate-certificate-btn" class="btn btn-success w-100">إنشاء شهادة الطلب</button></div><div id="withdraw-step-3" class="process-step"><div id="certificate" class="mb-3"></div><p class="text-center fw-bold">قم بتحميل هذه الشهادة وأرسلها للمسؤول.</p><button id="download-certificate-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> تحميل الشهادة</button></div></div></div></div></div>
    <div class="modal fade" id="depositModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">فاتورة إيداع روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="deposit-step-1" class="process-step"><div class="mb-3"><label for="deposit-amount" class="form-label">كم روبل تريد أن تودع؟</label><input type="number" class="form-control" id="deposit-amount" min="1"><small class="text-muted">يرجى مراجعة المسؤول لمعرفة السعر الحالي.</small></div><button id="generate-invoice-btn" class="btn btn-primary w-100">إنشاء فاتورة الإيداع</button></div><div id="deposit-step-2" class="process-step"><div id="deposit-invoice" class="mb-3"></div><p class="text-center fw-bold">حمّل الفاتورة وأرسلها مع إثبات الدفع للمسؤول.</p><button id="download-invoice-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> تحميل الفاتورة</button></div></div></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA9dfAX6QsQb2b5WQcg4x41oBw7UVnGrcA", authDomain: "qdjeizjeheidjd.firebaseapp.com", projectId: "qdjeizjeheidjd", storageBucket: "qdjeizjeheidjd.firebasestorage.app", messagingSenderId: "790923875489", appId: "1:790923875489:web:76ce647204360a15d80ce0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { serverTimestamp, arrayUnion } = firebase.firestore.FieldValue;
        const VIP_COST = 50, TAX_ACCOUNT_UID = 'E6TOBVW6QTEC', NORMAL_USER_TAX_RATE = 0.05, VIP_USER_TAX_RATE = 0.02, ADMIN_BANK_CARD = 'A020A';
        let unsubscribeUserSnapshot, unsubscribeTransactions, qrScanner, sendModal, confirmTransferModal, withdrawModal, depositModal, currentUserData;
        const loadingOverlay = document.getElementById('loading-overlay'), authSection = document.getElementById('auth-section'), mainSection = document.getElementById('main-section');
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        
        const pages = document.querySelectorAll('.page'), navItems = document.querySelectorAll('.nav-item');
        function navigateTo(pageId) {
            pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active');
            navItems.forEach(item => { item.classList.remove('active'); if (item.dataset.page === pageId) item.classList.add('active'); });
            if (pageId === 'leaderboard') loadLeaderboard();
        }
        navItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.dataset.page); }));

        auth.onAuthStateChanged(user => {
            if (unsubscribeUserSnapshot) unsubscribeUserSnapshot(); if (unsubscribeTransactions) unsubscribeTransactions();
            if (user) {
                sendModal = new bootstrap.Modal(document.getElementById('sendModal'));
                confirmTransferModal = new bootstrap.Modal(document.getElementById('confirmTransferModal'));
                withdrawModal = new bootstrap.Modal(document.getElementById('withdrawModal'));
                depositModal = new bootstrap.Modal(document.getElementById('depositModal'));
                mainSection.classList.add('active-section'); authSection.classList.remove('active-section'); navigateTo('profile');
                unsubscribeUserSnapshot = db.collection('users').doc(user.uid).onSnapshot(doc => { if (doc.exists) { currentUserData = doc.data(); updateUI(currentUserData); } hideLoading(); }, err => { console.error(err); hideLoading(); });
                listenToTransactions(user.uid);
            } else {
                currentUserData = null; mainSection.classList.remove('active-section'); authSection.classList.add('active-section'); hideLoading();
            }
        });

        function listenToTransactions(userId) {
            const historyList = document.getElementById('transaction-history');
            unsubscribeTransactions = db.collection('transactions').where('userId', '==', userId).orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
                if (snapshot.empty) { historyList.innerHTML = `<li class="list-group-item">لا توجد عمليات لعرضها.</li>`; return; }
                historyList.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const iconMap = { send: 'bi-arrow-up-right text-danger', receive: 'bi-arrow-down-left text-success', vip_purchase: 'bi-patch-check-fill text-warning', redeem: 'bi-gift-fill text-info', tax: 'bi-receipt text-secondary' };
                    const signMap = { send: '-', receive: '+', vip_purchase: '-', redeem: '+', tax: '-' };
                    const noteHTML = t.note ? `<p class="transaction-note mb-0">"${t.note}"</p>` : '';
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><i class="bi ${iconMap[t.type] || 'bi-info-circle'} me-2"></i>${t.details}${noteHTML}<small class="text-muted d-block">${new Date(t.timestamp?.toDate()).toLocaleString()}</small></div><span class="fw-bold ${t.type === 'receive' || t.type === 'redeem' ? 'text-success' : 'text-danger'}">${signMap[t.type] || ''} ${t.amount}</span>`;
                    historyList.appendChild(li);
                });
            });
        }
        function updateUI(userData) {
            document.getElementById('profile-username').textContent = userData.username;
            const uidEl = document.getElementById('profile-uid'); uidEl.textContent = userData.uid; uidEl.onclick = () => { navigator.clipboard.writeText(userData.uid); alert('تم نسخ الـ UID!'); };
            const statusBadge = document.getElementById('profile-status'); statusBadge.textContent = userData.VIP ? 'عضو VIP' : 'عضو عادي'; statusBadge.className = `badge fs-6 ${userData.VIP ? 'bg-warning text-dark' : 'bg-secondary'}`;
            document.getElementById('wallet-roble').textContent = userData.robleBalance || 0;
            const vipSection = document.getElementById('vip-section');
            if(userData.VIP) {
                vipSection.innerHTML = `<div class="card-body text-center"><h5 class="text-warning">⭐ أنت عضو VIP بالفعل ⭐</h5><p class="text-muted">تستمتع بميزات حصرية.</p></div>`;
            } else {
                vipSection.innerHTML = `<div class="card-body text-center"><h5 class="card-title">الترقية إلى عضوية VIP</h5><p class="card-text">احصل على ضريبة مخفضة وبطاقة ذهبية!</p><button id="buy-vip-btn" class="btn btn-warning">⭐ ترقية مقابل ${VIP_COST} روبل</button></div>`;
                document.getElementById('buy-vip-btn').addEventListener('click', purchaseVip);
            }
            renderDigitalCard(userData.username, userData.uid, userData.robleBalance || 0, userData.VIP);
        }
        function renderDigitalCard(username, uid, roble, isVIP) { const cardContainer = document.getElementById('digital-card-container'); const savedPic = localStorage.getItem('profilePic'); const picHTML = savedPic ? `<img src="${savedPic}" class="card-profile-pic">` : `<div class="card-placeholder-icon"><i class="bi bi-person-circle"></i></div>`; cardContainer.className = `card-digital mb-3 ${isVIP ? 'vip-card' : 'default-card'}`; cardContainer.innerHTML = `<div class="card-header-flex"><div><div class="card-header-logo">${isVIP ? 'VIP Membership' : 'عضوية مميزة'}</div>${isVIP ? '<span class="badge bg-light text-dark">VIP</span>' : ''}</div>${picHTML}</div><div class="mt-3"><div class="card-username">${username}</div><div class="card-uid">CARD ID: ${uid.substring(0, 12).toUpperCase()}</div></div><div class="card-balance-grid"><div class="card-balance"><span class="label">روبل</span><span class="amount"><i class="bi bi-coin"></i> ${roble}</span></div><div class="card-balance"><span class="label">غولد</span><span class="amount"><i class="bi bi-gem"></i> ${roble * 2}</span></div></div>`; }
        
        async function loadLeaderboard() {
            showLoading(); const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
            try { const snapshot = await db.collection('users').orderBy('robleBalance', 'desc').limit(10).get(); if (snapshot.empty) { list.innerHTML = `<li class="list-group-item">لا يوجد مستخدمون لعرضهم.</li>`; return; } snapshot.forEach((doc, index) => { const user = doc.data(); const li = document.createElement('li'); li.className = `list-group-item d-flex justify-content-between align-items-start leaderboard-item ${user.uid === auth.currentUser.uid ? 'current-user' : ''}`; li.innerHTML = `<div class="ms-2 me-auto"><div class="fw-bold"><span class="rank me-2" style="font-size:1.2rem;font-weight:700;color:#6c757d;">#${index+1}</span>${user.username}</div></div><span class="badge bg-primary rounded-pill">${user.robleBalance} روبل</span>`; list.appendChild(li); });
            } catch (error) { console.error(error); list.innerHTML = `<li class="list-group-item text-danger">فشل تحميل القائمة.</li>`; } finally { hideLoading(); }
        }
        
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form'), switchAuthLink = document.getElementById('switch-auth-mode');
        switchAuthLink.addEventListener('click', e => { e.preventDefault(); const isLoginVisible = !loginForm.classList.contains('d-none'); loginForm.classList.toggle('d-none', isLoginVisible); registerForm.classList.toggle('d-none', !isLoginVisible); switchAuthLink.previousElementSibling.previousElementSibling.textContent = isLoginVisible ? 'إنشاء حساب' : 'تسجيل دخول'; switchAuthLink.textContent = isLoginVisible ? 'لديك حساب؟' : 'ليس لديك حساب؟'; });
        loginForm.addEventListener('submit', e => { e.preventDefault(); showLoading(); auth.signInWithEmailAndPassword(loginForm.elements[0].value, loginForm.elements[1].value).catch(err => alert(err.message)).finally(hideLoading); });
        registerForm.addEventListener('submit', e => { e.preventDefault(); showLoading(); auth.createUserWithEmailAndPassword(registerForm.elements[1].value, registerForm.elements[2].value).then(cred => db.collection('users').doc(cred.user.uid).set({ uid: cred.user.uid, username: registerForm.elements[0].value, email: cred.user.email, robleBalance: 0, VIP: false, createdAt: serverTimestamp() })).catch(err => alert(err.message)).finally(hideLoading); });
        document.getElementById('redeem-code-form').addEventListener('submit', e => { e.preventDefault(); const code = document.getElementById('redeem-code-input').value.trim(); if(code) redeemCode(code); });
        document.getElementById('image-upload').addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('profilePic', e.target.result); if (auth.currentUser) db.collection('users').doc(auth.currentUser.uid).get().then(doc => { if (doc.exists) updateUI(doc.data()); }); }; reader.readAsDataURL(file); });
        document.getElementById('download-card-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('digital-card-container'), { backgroundColor: null, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = 'digital-card.png'; link.href = canvas.toDataURL('image/png'); link.click(); hideLoading(); }).catch(err => { console.error(err); alert("فشل تحميل البطاقة."); hideLoading(); }); });
        
        async function purchaseVip() { if (!confirm(`هل أنت متأكد من شراء عضوية VIP مقابل ${VIP_COST} روبل؟`)) return; showLoading(); const userRef = db.collection('users').doc(auth.currentUser.uid); try { await db.runTransaction(async t => { const userDoc = await t.get(userRef); if (!userDoc.exists) throw new Error("حسابك غير موجود."); const data = userDoc.data(); if (data.VIP) throw new Error("أنت عضو VIP بالفعل."); if ((data.robleBalance || 0) < VIP_COST) throw new Error("رصيدك غير كافٍ."); t.update(userRef, { robleBalance: data.robleBalance - VIP_COST, VIP: true }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'vip_purchase', amount: VIP_COST, details: 'شراء عضوية VIP', timestamp: serverTimestamp() }); }); alert("🎉 تهانينا! لقد أصبحت عضو VIP."); } catch (error) { alert(`فشلت الترقية: ${error.message}`); } finally { hideLoading(); } }
        async function redeemCode(code) {
            showLoading(); const userRef = db.collection('users').doc(auth.currentUser.uid); const codeRef = db.collection('codes').doc(code);
            try { await db.runTransaction(async t => { const [userDoc, codeDoc] = await Promise.all([t.get(userRef), t.get(codeRef)]); if (!codeDoc.exists) throw new Error("الكود غير صحيح."); const codeData = codeDoc.data(); if (codeData.redeemedBy?.includes(auth.currentUser.uid)) throw new Error("لقد استخدمت هذا الكود."); if(codeData.oneTimeUse && codeData.redeemedBy?.length > 0) throw new Error("هذا الكود تم استخدامه بالفعل."); const userData = userDoc.data(); t.update(userRef, { robleBalance: (userData.robleBalance || 0) + codeData.value }); t.update(codeRef, { redeemedBy: arrayUnion(auth.currentUser.uid) }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'redeem', amount: codeData.value, details: `استرداد الكود: ${code}`, timestamp: serverTimestamp() }); }); alert("تم استرداد الكود بنجاح!"); document.getElementById('redeem-code-form').reset(); } catch (error) { alert(`فشل: ${error.message}`); } finally { hideLoading(); }
        }
        
        document.getElementById('generate-qr-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('request-amount').value); if (!amount || amount <= 0) { return alert("أدخل مبلغ صحيح."); } const qrContainer = document.getElementById('qrcode-container'); qrContainer.innerHTML = ''; new QRCode(qrContainer, { text: JSON.stringify({ type: 'payment_request', recipientUid: auth.currentUser.uid, amount }), width: 256, height: 256 }); });
        document.getElementById('sendModal').addEventListener('shown.bs.modal', () => { document.getElementById('pills-qr-tab').addEventListener('shown.bs.tab', () => { qrScanner = new Html5Qrcode("qr-reader"); qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { if (qrScanner.isScanning) qrScanner.stop(); handleDecodedQrData(decodedText); }, () => {}).catch(() => {}); }); });
        document.getElementById('sendModal').addEventListener('hidden.bs.modal', () => { if (qrScanner && qrScanner.isScanning) qrScanner.stop(); });
        document.getElementById('qr-file-input').addEventListener('change', async e => { if (e.target.files.length === 0) return; showLoading(); const fileScanner = new Html5Qrcode("qr-reader"); try { const decodedText = await fileScanner.scanFile(e.target.files[0], true); handleDecodedQrData(decodedText); } catch (err) { alert("لم يتم العثور على كود QR."); } finally { hideLoading(); e.target.value = ''; } });
        async function handleDecodedQrData(decodedText) { showLoading(); sendModal.hide(); try { const data = JSON.parse(decodedText); if (data.type !== 'payment_request' || !data.recipientUid || !(data.amount > 0)) throw new Error('بيانات QR غير صالحة.'); const recipientDoc = await db.collection('users').doc(data.recipientUid).get(); if (!recipientDoc.exists) throw new Error('المستخدم المستلم غير موجود.'); const taxRate = currentUserData.VIP ? VIP_USER_TAX_RATE : NORMAL_USER_TAX_RATE; const taxAmount = Math.ceil(data.amount * taxRate); document.getElementById('confirm-recipient-name').textContent = recipientDoc.data().username; document.getElementById('confirm-amount').textContent = data.amount; document.getElementById('confirm-tax-label').textContent = `الضريبة (${taxRate * 100}%)`; document.getElementById('confirm-tax-amount').textContent = taxAmount; document.getElementById('confirm-total-deducted').textContent = data.amount + taxAmount; document.getElementById('confirmation-note').value = data.note || ''; const confirmBtn = document.getElementById('confirm-transfer-btn'); confirmBtn.dataset.recipientUid = data.recipientUid; confirmBtn.dataset.amount = data.amount; confirmBtn.dataset.taxAmount = taxAmount; confirmBtn.dataset.recipientName = recipientDoc.data().username; confirmTransferModal.show(); } catch(e) { alert(e.message); } finally { hideLoading(); } }
        document.getElementById('confirm-transfer-btn').addEventListener('click', (e) => { const { recipientUid, amount, taxAmount, recipientName } = e.currentTarget.dataset; const note = document.getElementById('confirmation-note').value.trim(); confirmTransferModal.hide(); performTransfer(recipientUid, parseInt(amount), parseInt(taxAmount), recipientName, note); });
        document.getElementById('send-by-id-form').addEventListener('submit', (e) => { e.preventDefault(); const recipientUid = document.getElementById('recipient-uid').value, amount = parseInt(document.getElementById('transfer-amount').value), note = document.getElementById('transfer-note').value.trim(); handleDecodedQrData(JSON.stringify({type:'payment_request', recipientUid, amount, note})); });
        async function performTransfer(recipientUid, amount, taxAmount, recipientName, note) { showLoading(); if (!auth.currentUser) { hideLoading(); return alert("يجب تسجيل الدخول."); } if (auth.currentUser.uid === recipientUid) { hideLoading(); return alert("لا يمكنك التحويل لنفسك."); } const senderRef = db.collection('users').doc(auth.currentUser.uid), recipientRef = db.collection('users').doc(recipientUid), taxAccountRef = db.collection('users').doc(TAX_ACCOUNT_UID); const totalDeducted = amount + taxAmount; try { await db.runTransaction(async t => { const [senderDoc, recipientDoc, taxDoc] = await Promise.all([t.get(senderRef), t.get(recipientRef), t.get(taxAccountRef)]); if (!senderDoc.exists || !recipientDoc.exists || !taxDoc.exists) throw new Error("خطأ في العثور على أحد الحسابات."); const senderBalance = senderDoc.data().robleBalance || 0; if (senderBalance < totalDeducted) throw new Error(`رصيدك غير كافٍ. تحتاج إلى ${totalDeducted}.`); t.update(senderRef, { robleBalance: senderBalance - totalDeducted }); t.update(recipientRef, { robleBalance: (recipientDoc.data().robleBalance || 0) + amount }); t.update(taxAccountRef, { robleBalance: (taxDoc.data().robleBalance || 0) + taxAmount }); const ts = serverTimestamp(); const transactionData = { userId: auth.currentUser.uid, type: 'send', amount, details: `إلى ${recipientName}`, timestamp: ts, note: note || null }; t.set(db.collection('transactions').doc(), transactionData); t.set(db.collection('transactions').doc(), { ...transactionData, userId: recipientUid, type: 'receive', details: `من ${currentUserData.username}` }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'tax', amount: taxAmount, details: 'ضريبة التحويل', timestamp: ts }); }); alert(`تم تحويل ${amount} روبل بنجاح!`); } catch (error) { console.error("Transfer failed: ", error); alert(`فشل التحويل: ${error.message}`); } finally { hideLoading(); } }

        const withdrawModalEl = document.getElementById('withdrawModal'), wdStep1 = document.getElementById('withdraw-step-1'), wdStep2 = document.getElementById('withdraw-step-2'), wdStep3 = document.getElementById('withdraw-step-3');
        const bankCardInputGroup = document.getElementById('bank-card-input-group');
        withdrawModalEl.addEventListener('show.bs.modal', () => { wdStep1.style.display = 'block'; wdStep2.style.display = 'none'; wdStep3.style.display = 'none'; document.getElementById('withdraw-amount').value = ''; document.getElementById('user-bank-card').value = ''; });
        document.getElementById('withdraw-next-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('withdraw-amount').value); if (!amount || amount <= 0 || amount > currentUserData.robleBalance) { alert("مبلغ غير صالح أو رصيد غير كافٍ."); return; } wdStep1.style.display = 'none'; wdStep2.style.display = 'block'; const withdrawType = document.querySelector('input[name="withdrawType"]:checked').value; bankCardInputGroup.classList.toggle('d-none', withdrawType !== 'bank'); });
        document.getElementById('generate-certificate-btn').addEventListener('click', async () => { showLoading(); const amount = parseInt(document.getElementById('withdraw-amount').value), type = document.querySelector('input[name="withdrawType"]:checked').value, userBankCard = document.getElementById('user-bank-card').value, requestId = `REQ-${Date.now()}`; if (type === 'bank' && !userBankCard) { alert("أدخل رقم بطاقتك."); hideLoading(); return; } const requestData = { requestId, userId: auth.currentUser.uid, username: currentUserData.username, amount, type, userBankCard: type === 'bank' ? userBankCard : null, status: 'pending', timestamp: serverTimestamp() }; try { await db.collection('withdraw_requests').doc(requestId).set(requestData); document.getElementById('certificate').innerHTML = `<h4 class="text-center">شهادة طلب سحب</h4><hr><p><strong>رقم الطلب:</strong> ${requestId}</p><p><strong>المستخدم:</strong> ${currentUserData.username}</p><hr><p><strong>المبلغ:</strong> ${amount} روبل</p><p><strong>النوع:</strong> ${type === 'gold' ? 'مقابل غولد' : 'أموال حقيقية'}</p>${type === 'bank' ? `<p><strong>بطاقتك:</strong> ${userBankCard}</p>` : ''}<hr><p><strong>الحالة:</strong> <span class="badge bg-warning text-dark">قيد الانتظار</span></p><hr><p class="fw-bold">الخطوات التالية:</p><ul class="instructions"><li><span class="num">1</span> قم بتحميل هذه الشهادة.</li><li><span class="num">2</span> أرسلها إلى المسؤول عبر فيسبوك.</li><li><span class="num">3</span> انتظر حتى يقوم المسؤول بمراجعة طلبك، خصم الروبل من حسابك، وإرسال الغولد/المال لك.</li></ul>`; wdStep2.style.display = 'none'; wdStep3.style.display = 'block'; } catch (error) { alert("حدث خطأ."); } finally { hideLoading(); } });
        document.getElementById('download-certificate-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('certificate')).then(canvas => { const link = document.createElement('a'); link.download = `withdraw-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); hideLoading(); if(withdrawModal) withdrawModal.hide(); }).catch(() => { alert("حدث خطأ."); hideLoading(); }); });
        
        const depositModalEl = document.getElementById('depositModal'), dpStep1 = document.getElementById('deposit-step-1'), dpStep2 = document.getElementById('deposit-step-2');
        depositModalEl.addEventListener('show.bs.modal', () => { dpStep1.style.display = 'block'; dpStep2.style.display = 'none'; document.getElementById('deposit-amount').value = ''; });
        document.getElementById('generate-invoice-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('deposit-amount').value); if (!amount || amount <= 0) { alert("أدخل مبلغ صحيح."); return; } const invoiceId = `INV-${Date.now()}`; document.getElementById('deposit-invoice').innerHTML = `<h4 class="text-center">فاتورة إيداع</h4><hr><p><strong>رقم الفاتورة:</strong> ${invoiceId}</p><p><strong>المستخدم:</strong> ${currentUserData.username}</p><hr><p><strong>المبلغ للحصول عليه:</strong> ${amount} روبل</p><p><strong>المبلغ المطلوب دفعه:</strong> ${amount}</p><p><strong>بطاقة المسؤول للدفع:</strong> ${ADMIN_BANK_CARD}</p><hr><p class="fw-bold">الخطوات التالية:</p><ul class="instructions"><li><span class="num">1</span> قم بتحويل المبلغ المحدد إلى بطاقة المسؤول.</li><li><span class="num">2</span> قم بتصوير إثبات الدفع من البنك.</li><li><span class="num">3</span> حمّل هذه الفاتورة.</li><li><span class="num">4</span> أرسل <strong>الفاتورة مع إثبات الدفع</strong> للمسؤول.</li><li><span class="num">5</span> سيقوم المسؤول بإضافة الروبل لحسابك بعد التحقق.</li></ul>`; dpStep1.style.display = 'none'; dpStep2.style.display = 'block'; });
        document.getElementById('download-invoice-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('deposit-invoice')).then(canvas => { const link = document.createElement('a'); link.download = `deposit-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); hideLoading(); if(depositModal) depositModal.hide(); }).catch(() => { alert("حدث خطأ."); hideLoading(); }); });
        
        document.addEventListener('DOMContentLoaded', () => { showLoading(); });
    </script>
</body>
</html>
