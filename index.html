<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨ÙŠ - Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0d6efd; --background-gradient: linear-gradient(to top, #f2f4f6 0%, #ffffff 100%); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); --border-radius: 12px; }
        body { font-family: 'Cairo', sans-serif; background: var(--background-gradient); padding-bottom: 80px; }
        .main-content, .auth-container { display: none; }
        .active-section { display: block; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .auth-container { max-width: 450px; margin: 5rem auto; }
        .auth-container .card { border: none; border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
        .page-header { font-weight: 700; color: #333; margin-bottom: 1.5rem; }
        .content-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); border: 1px solid #e9ecef; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: #ffffff; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 1000; border-top: 1px solid #f0f0f0; }
        .nav-item { flex-basis: 0; flex-grow: 1; display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; transition: all 0.3s ease; }
        .nav-item i { font-size: 1.5rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); }
        .card-digital { color: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; transition: all 0.5s ease; }
        .card-digital.default-card { background: linear-gradient(to right, #8f94fb, #4e54c8); }
        .card-digital.vip-card { background: linear-gradient(to right, #243B55, #141E30); }
        .card-header-flex { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-header-logo { font-size: 1.2rem; font-weight: bold; }
        .card-profile-pic { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); object-fit: cover; background-color: rgba(255,255,255,0.2); }
        .card-placeholder-icon { font-size: 60px; color: rgba(255,255,255,0.5); }
        .card-username { font-size: 1.8rem; font-weight: 700; margin-top: 15px; }
        .card-uid { font-family: monospace; letter-spacing: 2px; font-size: 0.8rem; color: #bdc3c7; opacity: 0.8; }
        .card-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; text-align: right; }
        .card-balance .label { font-size: 0.9rem; color: #ecf0f1; opacity: 0.8; }
        .card-balance .amount { font-size: 1.7rem; font-weight: 700; }
        .transaction-note { font-style: italic; color: #6c757d; font-size: 0.85rem; }
        .process-step { display: none; }
        #certificate, #deposit-invoice { border: 2px solid #333; background: #fdfdfd; padding: 1.5rem; color: #000; }
        .instructions { list-style-type: none; padding-right: 0; }
        .instructions li { margin-bottom: 0.5rem; }
        .instructions li .num { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background-color: #333; color: #fff; font-size: 0.8rem; margin-left: 0.5rem; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1080; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="auth-section" class="auth-container"><div class="card p-4"><h3 class="text-center mb-4" id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3><form id="login-form"><div class="mb-3"><label for="login-email" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" class="form-control" id="login-email" required></div><div class="mb-3"><label for="login-password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" class="form-control" id="login-password" required></div><button type="submit" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button></form><form id="register-form" class="d-none"><div class="mb-3"><label for="register-username" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" class="form-control" id="register-username" required></div><div class="mb-3"><label for="register-email" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" class="form-control" id="register-email" required></div><div class="mb-3"><label for="register-password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" class="form-control" id="register-password" minlength="6" required></div><button type="submit" class="btn btn-success w-100">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button></form><div id="auth-error" class="alert alert-danger mt-3 d-none"></div><p class="text-center mt-3 mb-0"><a href="#" id="switch-auth-mode">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p></div></div>
    <div id="main-section" class="main-content">
        <div class="container mt-4">
            <div id="profile" class="page"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="page-header mb-0">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ</h3><span id="profile-status" class="badge fs-6"></span></div><div class="content-card mb-3"><div class="card-body"><ul class="list-group list-group-flush"><li class="list-group-item"><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> <span id="profile-username"></span></li><li class="list-group-item"><strong>UID:</strong> <code id="profile-uid" class="text-muted" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®"></code></li></ul></div></div><div id="vip-section" class="content-card"></div></div>
            <div id="wallet" class="page">
                <h3 class="page-header">Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                <div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title"><i class="bi bi-coin"></i> Ø±ØµÙŠØ¯ Ø§Ù„Ø±ÙˆØ¨Ù„</h5><p class="card-text fs-1 fw-bold" id="wallet-roble">0</p></div></div>
                <div class="row g-2 mb-4">
                    <div class="col-6 d-grid"><button class="btn btn-success btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#sendModal"><i class="bi bi-arrow-up-right-circle"></i> Ø¥Ø±Ø³Ø§Ù„</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-primary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#requestModal"><i class="bi bi-qr-code"></i> Ø·Ù„Ø¨</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-info text-white btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#depositModal"><i class="bi bi-arrow-down-left-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹</button></div>
                    <div class="col-6 d-grid"><button class="btn btn-secondary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#withdrawModal"><i class="bi bi-arrow-repeat"></i> Ø³Ø­Ø¨</button></div>
                </div>
                <div class="content-card mb-4"><div class="card-body"><h5 class="card-title">Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙƒÙˆØ¯ Ù‡Ø¯ÙŠØ©</h5><form id="redeem-code-form" class="d-flex"><input type="text" id="redeem-code-input" class="form-control me-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" required><button class="btn btn-warning" type="submit">Ø§Ø³ØªØ±Ø¯Ø§Ø¯</button></form></div></div>
                <div class="content-card"><div class="card-header bg-white"><h5><i class="bi bi-list-ul"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h5></div><div class="card-body p-0"><ul id="transaction-history" class="list-group list-group-flush"></ul></div></div>
            </div>
            <div id="leaderboard" class="page"><h3 class="page-header">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3><div class="content-card"><div class="card-body"><ol id="leaderboard-list" class="list-group list-group-numbered"></ol></div></div></div>
            <div id="card" class="page"><h3 class="page-header">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3><div id="digital-card-container" class="card-digital default-card mb-3"></div><div class="content-card mb-3"><div class="card-body"><label for="image-upload" class="form-label">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input class="form-control" type="file" id="image-upload" accept="image/*"></div></div><button id="download-card-btn" class="btn btn-success w-100"><i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØµÙˆØ±Ø©</button></div>
        </div>
        <nav class="bottom-nav"><a href="#" class="nav-item" data-page="profile"><i class="bi bi-person-fill"></i><span>Ø§Ù„Ø­Ø³Ø§Ø¨</span></a><a href="#" class="nav-item" data-page="wallet"><i class="bi bi-wallet-fill"></i><span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span></a><a href="#" class="nav-item" data-page="leaderboard"><i class="bi bi-trophy-fill"></i><span>Ø§Ù„ØµØ¯Ø§Ø±Ø©</span></a><a href="#" class="nav-item" data-page="card"><i class="bi bi-credit-card-2-front-fill"></i><span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</span></a></nav>
    </div>
    <div class="modal fade" id="sendModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ¨Ù„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-pills nav-fill mb-3" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-id">Ø¹Ø¨Ø± ID</button></li><li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-qr">Ù…Ø³Ø­ QR</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="pills-id"><form id="send-by-id-form"><div class="mb-3"><label class="form-label">UID Ø§Ù„Ù…Ø³ØªÙ„Ù…</label><input type="text" class="form-control" id="recipient-uid" required></div><div class="mb-3"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" class="form-control" id="transfer-amount" min="1" required></div><div class="mb-3"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="text" class="form-control" id="transfer-note" placeholder="Ù…Ø«Ø§Ù„: Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ"></div><button type="submit" class="btn btn-primary w-100">ØªØ£ÙƒÙŠØ¯</button></form></div><div class="tab-pane fade" id="pills-qr"><div id="qr-reader" style="width:100%; border-radius:12px; border:2px dashed #ccc; overflow:hidden;"></div><hr><input type="file" id="qr-file-input" class="d-none" accept="image/*"><label for="qr-file-input" class="btn btn-secondary w-100"><i class="bi bi-image"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø© QR</label></div></div></div></div></div></div>
    <div class="modal fade" id="requestModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ø·Ù„Ø¨ Ø±ÙˆØ¨Ù„ Ø¹Ø¨Ø± QR</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label><input type="number" class="form-control" id="request-amount" min="1"></div><button id="generate-qr-btn" class="btn btn-primary w-100 mb-3">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯</button><div id="qrcode-container" style="display:flex; justify-content:center; align-items:center; padding:1rem; border:1px solid #eee; border-radius:12px; min-height:280px;"><span class="text-muted">Ø³ÙŠØ¸Ù‡Ø± ÙƒÙˆØ¯ QR Ù‡Ù†Ø§</span></div></div></div></div></div>
    <div class="modal fade" id="confirmTransferModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mt-2">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ¨Ù„ Ø¥Ù„Ù‰:</h5><h3 class="mb-1" id="confirm-recipient-name">...</h3><hr><p class="text-muted mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</p><p class="fs-3 fw-bold" id="confirm-amount">0</p><p class="text-muted mb-1" id="confirm-tax-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</p><p class="fs-5" id="confirm-tax-amount">0</p><p class="text-muted mb-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®ØµÙˆÙ…</p><p class="fs-4 fw-bold" id="confirm-total-deducted">0</p><div class="my-3"><label class="form-label">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="text" class="form-control" id="confirmation-note"></div><div class="d-grid gap-2 mt-4"><button type="button" class="btn btn-primary btn-lg" id="confirm-transfer-btn">Ù†Ø¹Ù…ØŒ Ø£ÙˆØ§ÙÙ‚</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Ø±ÙØ¶</button></div></div></div></div></div>
    <div class="modal fade" id="withdrawModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø±ÙˆØ¨Ù„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="withdraw-step-1" class="process-step"><div class="mb-3"><label for="withdraw-amount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡</label><input type="number" class="form-control" id="withdraw-amount" min="1"></div><div class="mb-3"><label class="form-label">Ø§Ù„Ø³Ø­Ø¨ Ù…Ù‚Ø§Ø¨Ù„</label><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeGold" value="gold" checked><label class="form-check-label" for="typeGold">ØºÙˆÙ„Ø¯</label></div><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeBank" value="bank"><label class="form-check-label" for="typeBank">Ø£Ù…ÙˆØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©</label></div></div><button id="withdraw-next-btn" class="btn btn-primary w-100">Ø§Ù„ØªØ§Ù„ÙŠ</button></div><div id="withdraw-step-2" class="process-step"><div id="bank-card-input-group" class="mb-3 d-none"><label for="user-bank-card" class="form-label">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚ØªÙƒ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="text" class="form-control" id="user-bank-card"></div><button id="generate-certificate-btn" class="btn btn-success w-100">Ø¥Ù†Ø´Ø§Ø¡ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</button></div><div id="withdraw-step-3" class="process-step"><div id="certificate" class="mb-3"></div><p class="text-center fw-bold">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„.</p><button id="download-certificate-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button></div></div></div></div></div>
    <div class="modal fade" id="depositModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ÙØ§ØªÙˆØ±Ø© Ø¥ÙŠØ¯Ø§Ø¹ Ø±ÙˆØ¨Ù„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="deposit-step-1" class="process-step"><div class="mb-3"><label for="deposit-amount" class="form-label">ÙƒÙ… Ø±ÙˆØ¨Ù„ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙˆØ¯Ø¹ØŸ</label><input type="number" class="form-control" id="deposit-amount" min="1"><small class="text-muted">ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.</small></div><button id="generate-invoice-btn" class="btn btn-primary w-100">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</button></div><div id="deposit-step-2" class="process-step"><div id="deposit-invoice" class="mb-3"></div><p class="text-center fw-bold">Ø­Ù…Ù‘Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ù…Ø¹ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„.</p><button id="download-invoice-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button></div></div></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA9dfAX6QsQb2b5WQcg4x41oBw7UVnGrcA", authDomain: "qdjeizjeheidjd.firebaseapp.com", projectId: "qdjeizjeheidjd", storageBucket: "qdjeizjeheidjd.firebasestorage.app", messagingSenderId: "790923875489", appId: "1:790923875489:web:76ce647204360a15d80ce0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { serverTimestamp, arrayUnion } = firebase.firestore.FieldValue;
        const VIP_COST = 50, TAX_ACCOUNT_UID = 'E6TOBVW6QTEC', NORMAL_USER_TAX_RATE = 0.05, VIP_USER_TAX_RATE = 0.02, ADMIN_BANK_CARD = 'A020A';
        let unsubscribeUserSnapshot, unsubscribeTransactions, qrScanner, sendModal, confirmTransferModal, withdrawModal, depositModal, currentUserData;
        const loadingOverlay = document.getElementById('loading-overlay'), authSection = document.getElementById('auth-section'), mainSection = document.getElementById('main-section');
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        
        const pages = document.querySelectorAll('.page'), navItems = document.querySelectorAll('.nav-item');
        function navigateTo(pageId) {
            pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active');
            navItems.forEach(item => { item.classList.remove('active'); if (item.dataset.page === pageId) item.classList.add('active'); });
            if (pageId === 'leaderboard') loadLeaderboard();
        }
        navItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.dataset.page); }));

        auth.onAuthStateChanged(user => {
            if (unsubscribeUserSnapshot) unsubscribeUserSnapshot(); if (unsubscribeTransactions) unsubscribeTransactions();
            if (user) {
                sendModal = new bootstrap.Modal(document.getElementById('sendModal'));
                confirmTransferModal = new bootstrap.Modal(document.getElementById('confirmTransferModal'));
                withdrawModal = new bootstrap.Modal(document.getElementById('withdrawModal'));
                depositModal = new bootstrap.Modal(document.getElementById('depositModal'));
                mainSection.classList.add('active-section'); authSection.classList.remove('active-section'); navigateTo('profile');
                unsubscribeUserSnapshot = db.collection('users').doc(user.uid).onSnapshot(doc => { if (doc.exists) { currentUserData = doc.data(); updateUI(currentUserData); } hideLoading(); }, err => { console.error(err); hideLoading(); });
                listenToTransactions(user.uid);
            } else {
                currentUserData = null; mainSection.classList.remove('active-section'); authSection.classList.add('active-section'); hideLoading();
            }
        });

        function listenToTransactions(userId) {
            const historyList = document.getElementById('transaction-history');
            unsubscribeTransactions = db.collection('transactions').where('userId', '==', userId).orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
                if (snapshot.empty) { historyList.innerHTML = `<li class="list-group-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</li>`; return; }
                historyList.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const iconMap = { send: 'bi-arrow-up-right text-danger', receive: 'bi-arrow-down-left text-success', vip_purchase: 'bi-patch-check-fill text-warning', redeem: 'bi-gift-fill text-info', tax: 'bi-receipt text-secondary' };
                    const signMap = { send: '-', receive: '+', vip_purchase: '-', redeem: '+', tax: '-' };
                    const noteHTML = t.note ? `<p class="transaction-note mb-0">"${t.note}"</p>` : '';
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><i class="bi ${iconMap[t.type] || 'bi-info-circle'} me-2"></i>${t.details}${noteHTML}<small class="text-muted d-block">${new Date(t.timestamp?.toDate()).toLocaleString()}</small></div><span class="fw-bold ${t.type === 'receive' || t.type === 'redeem' ? 'text-success' : 'text-danger'}">${signMap[t.type] || ''} ${t.amount}</span>`;
                    historyList.appendChild(li);
                });
            });
        }
        function updateUI(userData) {
            document.getElementById('profile-username').textContent = userData.username;
            const uidEl = document.getElementById('profile-uid'); uidEl.textContent = userData.uid; uidEl.onclick = () => { navigator.clipboard.writeText(userData.uid); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù€ UID!'); };
            const statusBadge = document.getElementById('profile-status'); statusBadge.textContent = userData.VIP ? 'Ø¹Ø¶Ùˆ VIP' : 'Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ'; statusBadge.className = `badge fs-6 ${userData.VIP ? 'bg-warning text-dark' : 'bg-secondary'}`;
            document.getElementById('wallet-roble').textContent = userData.robleBalance || 0;
            const vipSection = document.getElementById('vip-section');
            if(userData.VIP) {
                vipSection.innerHTML = `<div class="card-body text-center"><h5 class="text-warning">â­ Ø£Ù†Øª Ø¹Ø¶Ùˆ VIP Ø¨Ø§Ù„ÙØ¹Ù„ â­</h5><p class="text-muted">ØªØ³ØªÙ…ØªØ¹ Ø¨Ù…ÙŠØ²Ø§Øª Ø­ØµØ±ÙŠØ©.</p></div>`;
            } else {
                vipSection.innerHTML = `<div class="card-body text-center"><h5 class="card-title">Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØ© VIP</h5><p class="card-text">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¶Ø±ÙŠØ¨Ø© Ù…Ø®ÙØ¶Ø© ÙˆØ¨Ø·Ø§Ù‚Ø© Ø°Ù‡Ø¨ÙŠØ©!</p><button id="buy-vip-btn" class="btn btn-warning">â­ ØªØ±Ù‚ÙŠØ© Ù…Ù‚Ø§Ø¨Ù„ ${VIP_COST} Ø±ÙˆØ¨Ù„</button></div>`;
                document.getElementById('buy-vip-btn').addEventListener('click', purchaseVip);
            }
            renderDigitalCard(userData.username, userData.uid, userData.robleBalance || 0, userData.VIP);
        }
        function renderDigitalCard(username, uid, roble, isVIP) { const cardContainer = document.getElementById('digital-card-container'); const savedPic = localStorage.getItem('profilePic'); const picHTML = savedPic ? `<img src="${savedPic}" class="card-profile-pic">` : `<div class="card-placeholder-icon"><i class="bi bi-person-circle"></i></div>`; cardContainer.className = `card-digital mb-3 ${isVIP ? 'vip-card' : 'default-card'}`; cardContainer.innerHTML = `<div class="card-header-flex"><div><div class="card-header-logo">${isVIP ? 'VIP Membership' : 'Ø¹Ø¶ÙˆÙŠØ© Ù…Ù…ÙŠØ²Ø©'}</div>${isVIP ? '<span class="badge bg-light text-dark">VIP</span>' : ''}</div>${picHTML}</div><div class="mt-3"><div class="card-username">${username}</div><div class="card-uid">CARD ID: ${uid.substring(0, 12).toUpperCase()}</div></div><div class="card-balance-grid"><div class="card-balance"><span class="label">Ø±ÙˆØ¨Ù„</span><span class="amount"><i class="bi bi-coin"></i> ${roble}</span></div><div class="card-balance"><span class="label">ØºÙˆÙ„Ø¯</span><span class="amount"><i class="bi bi-gem"></i> ${roble * 2}</span></div></div>`; }
        
        async function loadLeaderboard() {
            showLoading(); const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
            try { const snapshot = await db.collection('users').orderBy('robleBalance', 'desc').limit(10).get(); if (snapshot.empty) { list.innerHTML = `<li class="list-group-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù….</li>`; return; } snapshot.forEach((doc, index) => { const user = doc.data(); const li = document.createElement('li'); li.className = `list-group-item d-flex justify-content-between align-items-start leaderboard-item ${user.uid === auth.currentUser.uid ? 'current-user' : ''}`; li.innerHTML = `<div class="ms-2 me-auto"><div class="fw-bold"><span class="rank me-2" style="font-size:1.2rem;font-weight:700;color:#6c757d;">#${index+1}</span>${user.username}</div></div><span class="badge bg-primary rounded-pill">${user.robleBalance} Ø±ÙˆØ¨Ù„</span>`; list.appendChild(li); });
            } catch (error) { console.error(error); list.innerHTML = `<li class="list-group-item text-danger">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</li>`; } finally { hideLoading(); }
        }
        
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form'), switchAuthLink = document.getElementById('switch-auth-mode');
        switchAuthLink.addEventListener('click', e => { e.preventDefault(); const isLoginVisible = !loginForm.classList.contains('d-none'); loginForm.classList.toggle('d-none', isLoginVisible); registerForm.classList.toggle('d-none', !isLoginVisible); switchAuthLink.previousElementSibling.previousElementSibling.textContent = isLoginVisible ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„'; switchAuthLink.textContent = isLoginVisible ? 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ' : 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ'; });
        loginForm.addEventListener('submit', e => { e.preventDefault(); showLoading(); auth.signInWithEmailAndPassword(loginForm.elements[0].value, loginForm.elements[1].value).catch(err => alert(err.message)).finally(hideLoading); });
        registerForm.addEventListener('submit', e => { e.preventDefault(); showLoading(); auth.createUserWithEmailAndPassword(registerForm.elements[1].value, registerForm.elements[2].value).then(cred => db.collection('users').doc(cred.user.uid).set({ uid: cred.user.uid, username: registerForm.elements[0].value, email: cred.user.email, robleBalance: 0, VIP: false, createdAt: serverTimestamp() })).catch(err => alert(err.message)).finally(hideLoading); });
        document.getElementById('redeem-code-form').addEventListener('submit', e => { e.preventDefault(); const code = document.getElementById('redeem-code-input').value.trim(); if(code) redeemCode(code); });
        document.getElementById('image-upload').addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('profilePic', e.target.result); if (auth.currentUser) db.collection('users').doc(auth.currentUser.uid).get().then(doc => { if (doc.exists) updateUI(doc.data()); }); }; reader.readAsDataURL(file); });
        document.getElementById('download-card-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('digital-card-container'), { backgroundColor: null, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = 'digital-card.png'; link.href = canvas.toDataURL('image/png'); link.click(); hideLoading(); }).catch(err => { console.error(err); alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©."); hideLoading(); }); });
        
        async function purchaseVip() { if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø±Ø§Ø¡ Ø¹Ø¶ÙˆÙŠØ© VIP Ù…Ù‚Ø§Ø¨Ù„ ${VIP_COST} Ø±ÙˆØ¨Ù„ØŸ`)) return; showLoading(); const userRef = db.collection('users').doc(auth.currentUser.uid); try { await db.runTransaction(async t => { const userDoc = await t.get(userRef); if (!userDoc.exists) throw new Error("Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."); const data = userDoc.data(); if (data.VIP) throw new Error("Ø£Ù†Øª Ø¹Ø¶Ùˆ VIP Ø¨Ø§Ù„ÙØ¹Ù„."); if ((data.robleBalance || 0) < VIP_COST) throw new Error("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); t.update(userRef, { robleBalance: data.robleBalance - VIP_COST, VIP: true }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'vip_purchase', amount: VIP_COST, details: 'Ø´Ø±Ø§Ø¡ Ø¹Ø¶ÙˆÙŠØ© VIP', timestamp: serverTimestamp() }); }); alert("ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­Øª Ø¹Ø¶Ùˆ VIP."); } catch (error) { alert(`ÙØ´Ù„Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©: ${error.message}`); } finally { hideLoading(); } }
        async function redeemCode(code) {
            showLoading(); const userRef = db.collection('users').doc(auth.currentUser.uid); const codeRef = db.collection('codes').doc(code);
            try { await db.runTransaction(async t => { const [userDoc, codeDoc] = await Promise.all([t.get(userRef), t.get(codeRef)]); if (!codeDoc.exists) throw new Error("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­."); const codeData = codeDoc.data(); if (codeData.redeemedBy?.includes(auth.currentUser.uid)) throw new Error("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯."); if(codeData.oneTimeUse && codeData.redeemedBy?.length > 0) throw new Error("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„."); const userData = userDoc.data(); t.update(userRef, { robleBalance: (userData.robleBalance || 0) + codeData.value }); t.update(codeRef, { redeemedBy: arrayUnion(auth.currentUser.uid) }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'redeem', amount: codeData.value, details: `Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯: ${code}`, timestamp: serverTimestamp() }); }); alert("ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!"); document.getElementById('redeem-code-form').reset(); } catch (error) { alert(`ÙØ´Ù„: ${error.message}`); } finally { hideLoading(); }
        }
        
        document.getElementById('generate-qr-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('request-amount').value); if (!amount || amount <= 0) { return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­."); } const qrContainer = document.getElementById('qrcode-container'); qrContainer.innerHTML = ''; new QRCode(qrContainer, { text: JSON.stringify({ type: 'payment_request', recipientUid: auth.currentUser.uid, amount }), width: 256, height: 256 }); });
        document.getElementById('sendModal').addEventListener('shown.bs.modal', () => { document.getElementById('pills-qr-tab').addEventListener('shown.bs.tab', () => { qrScanner = new Html5Qrcode("qr-reader"); qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { if (qrScanner.isScanning) qrScanner.stop(); handleDecodedQrData(decodedText); }, () => {}).catch(() => {}); }); });
        document.getElementById('sendModal').addEventListener('hidden.bs.modal', () => { if (qrScanner && qrScanner.isScanning) qrScanner.stop(); });
        document.getElementById('qr-file-input').addEventListener('change', async e => { if (e.target.files.length === 0) return; showLoading(); const fileScanner = new Html5Qrcode("qr-reader"); try { const decodedText = await fileScanner.scanFile(e.target.files[0], true); handleDecodedQrData(decodedText); } catch (err) { alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ QR."); } finally { hideLoading(); e.target.value = ''; } });
        async function handleDecodedQrData(decodedText) { showLoading(); sendModal.hide(); try { const data = JSON.parse(decodedText); if (data.type !== 'payment_request' || !data.recipientUid || !(data.amount > 0)) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª QR ØºÙŠØ± ØµØ§Ù„Ø­Ø©.'); const recipientDoc = await db.collection('users').doc(data.recipientUid).get(); if (!recipientDoc.exists) throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); const taxRate = currentUserData.VIP ? VIP_USER_TAX_RATE : NORMAL_USER_TAX_RATE; const taxAmount = Math.ceil(data.amount * taxRate); document.getElementById('confirm-recipient-name').textContent = recipientDoc.data().username; document.getElementById('confirm-amount').textContent = data.amount; document.getElementById('confirm-tax-label').textContent = `Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (${taxRate * 100}%)`; document.getElementById('confirm-tax-amount').textContent = taxAmount; document.getElementById('confirm-total-deducted').textContent = data.amount + taxAmount; document.getElementById('confirmation-note').value = data.note || ''; const confirmBtn = document.getElementById('confirm-transfer-btn'); confirmBtn.dataset.recipientUid = data.recipientUid; confirmBtn.dataset.amount = data.amount; confirmBtn.dataset.taxAmount = taxAmount; confirmBtn.dataset.recipientName = recipientDoc.data().username; confirmTransferModal.show(); } catch(e) { alert(e.message); } finally { hideLoading(); } }
        document.getElementById('confirm-transfer-btn').addEventListener('click', (e) => { const { recipientUid, amount, taxAmount, recipientName } = e.currentTarget.dataset; const note = document.getElementById('confirmation-note').value.trim(); confirmTransferModal.hide(); performTransfer(recipientUid, parseInt(amount), parseInt(taxAmount), recipientName, note); });
        document.getElementById('send-by-id-form').addEventListener('submit', (e) => { e.preventDefault(); const recipientUid = document.getElementById('recipient-uid').value, amount = parseInt(document.getElementById('transfer-amount').value), note = document.getElementById('transfer-note').value.trim(); handleDecodedQrData(JSON.stringify({type:'payment_request', recipientUid, amount, note})); });
        async function performTransfer(recipientUid, amount, taxAmount, recipientName, note) { showLoading(); if (!auth.currentUser) { hideLoading(); return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."); } if (auth.currentUser.uid === recipientUid) { hideLoading(); return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ."); } const senderRef = db.collection('users').doc(auth.currentUser.uid), recipientRef = db.collection('users').doc(recipientUid), taxAccountRef = db.collection('users').doc(TAX_ACCOUNT_UID); const totalDeducted = amount + taxAmount; try { await db.runTransaction(async t => { const [senderDoc, recipientDoc, taxDoc] = await Promise.all([t.get(senderRef), t.get(recipientRef), t.get(taxAccountRef)]); if (!senderDoc.exists || !recipientDoc.exists || !taxDoc.exists) throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª."); const senderBalance = senderDoc.data().robleBalance || 0; if (senderBalance < totalDeducted) throw new Error(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${totalDeducted}.`); t.update(senderRef, { robleBalance: senderBalance - totalDeducted }); t.update(recipientRef, { robleBalance: (recipientDoc.data().robleBalance || 0) + amount }); t.update(taxAccountRef, { robleBalance: (taxDoc.data().robleBalance || 0) + taxAmount }); const ts = serverTimestamp(); const transactionData = { userId: auth.currentUser.uid, type: 'send', amount, details: `Ø¥Ù„Ù‰ ${recipientName}`, timestamp: ts, note: note || null }; t.set(db.collection('transactions').doc(), transactionData); t.set(db.collection('transactions').doc(), { ...transactionData, userId: recipientUid, type: 'receive', details: `Ù…Ù† ${currentUserData.username}` }); t.set(db.collection('transactions').doc(), { userId: auth.currentUser.uid, type: 'tax', amount: taxAmount, details: 'Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„', timestamp: ts }); }); alert(`ØªÙ… ØªØ­ÙˆÙŠÙ„ ${amount} Ø±ÙˆØ¨Ù„ Ø¨Ù†Ø¬Ø§Ø­!`); } catch (error) { console.error("Transfer failed: ", error); alert(`ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${error.message}`); } finally { hideLoading(); } }

        const withdrawModalEl = document.getElementById('withdrawModal'), wdStep1 = document.getElementById('withdraw-step-1'), wdStep2 = document.getElementById('withdraw-step-2'), wdStep3 = document.getElementById('withdraw-step-3');
        const bankCardInputGroup = document.getElementById('bank-card-input-group');
        withdrawModalEl.addEventListener('show.bs.modal', () => { wdStep1.style.display = 'block'; wdStep2.style.display = 'none'; wdStep3.style.display = 'none'; document.getElementById('withdraw-amount').value = ''; document.getElementById('user-bank-card').value = ''; });
        document.getElementById('withdraw-next-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('withdraw-amount').value); if (!amount || amount <= 0 || amount > currentUserData.robleBalance) { alert("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ."); return; } wdStep1.style.display = 'none'; wdStep2.style.display = 'block'; const withdrawType = document.querySelector('input[name="withdrawType"]:checked').value; bankCardInputGroup.classList.toggle('d-none', withdrawType !== 'bank'); });
        document.getElementById('generate-certificate-btn').addEventListener('click', async () => { showLoading(); const amount = parseInt(document.getElementById('withdraw-amount').value), type = document.querySelector('input[name="withdrawType"]:checked').value, userBankCard = document.getElementById('user-bank-card').value, requestId = `REQ-${Date.now()}`; if (type === 'bank' && !userBankCard) { alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚ØªÙƒ."); hideLoading(); return; } const requestData = { requestId, userId: auth.currentUser.uid, username: currentUserData.username, amount, type, userBankCard: type === 'bank' ? userBankCard : null, status: 'pending', timestamp: serverTimestamp() }; try { await db.collection('withdraw_requests').doc(requestId).set(requestData); document.getElementById('certificate').innerHTML = `<h4 class="text-center">Ø´Ù‡Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø³Ø­Ø¨</h4><hr><p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${requestId}</p><p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${currentUserData.username}</p><hr><p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${amount} Ø±ÙˆØ¨Ù„</p><p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${type === 'gold' ? 'Ù…Ù‚Ø§Ø¨Ù„ ØºÙˆÙ„Ø¯' : 'Ø£Ù…ÙˆØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©'}</p>${type === 'bank' ? `<p><strong>Ø¨Ø·Ø§Ù‚ØªÙƒ:</strong> ${userBankCard}</p>` : ''}<hr><p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge bg-warning text-dark">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span></p><hr><p class="fw-bold">Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p><ul class="instructions"><li><span class="num">1</span> Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©.</li><li><span class="num">2</span> Ø£Ø±Ø³Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø¨Ø± ÙÙŠØ³Ø¨ÙˆÙƒ.</li><li><span class="num">3</span> Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨ÙƒØŒ Ø®ØµÙ… Ø§Ù„Ø±ÙˆØ¨Ù„ Ù…Ù† Ø­Ø³Ø§Ø¨ÙƒØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØºÙˆÙ„Ø¯/Ø§Ù„Ù…Ø§Ù„ Ù„Ùƒ.</li></ul>`; wdStep2.style.display = 'none'; wdStep3.style.display = 'block'; } catch (error) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£."); } finally { hideLoading(); } });
        document.getElementById('download-certificate-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('certificate')).then(canvas => { const link = document.createElement('a'); link.download = `withdraw-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); hideLoading(); if(withdrawModal) withdrawModal.hide(); }).catch(() => { alert("Ø­Ø¯Ø« Ø®Ø·Ø£."); hideLoading(); }); });
        
        const depositModalEl = document.getElementById('depositModal'), dpStep1 = document.getElementById('deposit-step-1'), dpStep2 = document.getElementById('deposit-step-2');
        depositModalEl.addEventListener('show.bs.modal', () => { dpStep1.style.display = 'block'; dpStep2.style.display = 'none'; document.getElementById('deposit-amount').value = ''; });
        document.getElementById('generate-invoice-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('deposit-amount').value); if (!amount || amount <= 0) { alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return; } const invoiceId = `INV-${Date.now()}`; document.getElementById('deposit-invoice').innerHTML = `<h4 class="text-center">ÙØ§ØªÙˆØ±Ø© Ø¥ÙŠØ¯Ø§Ø¹</h4><hr><p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${invoiceId}</p><p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${currentUserData.username}</p><hr><p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡:</strong> ${amount} Ø±ÙˆØ¨Ù„</p><p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹Ù‡:</strong> ${amount}</p><p><strong>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„Ø¯ÙØ¹:</strong> ${ADMIN_BANK_CARD}</p><hr><p class="fw-bold">Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p><ul class="instructions"><li><span class="num">1</span> Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</li><li><span class="num">2</span> Ù‚Ù… Ø¨ØªØµÙˆÙŠØ± Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ.</li><li><span class="num">3</span> Ø­Ù…Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.</li><li><span class="num">4</span> Ø£Ø±Ø³Ù„ <strong>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</strong> Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„.</li><li><span class="num">5</span> Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ÙˆØ¨Ù„ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚.</li></ul>`; dpStep1.style.display = 'none'; dpStep2.style.display = 'block'; });
        document.getElementById('download-invoice-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('deposit-invoice')).then(canvas => { const link = document.createElement('a'); link.download = `deposit-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); hideLoading(); if(depositModal) depositModal.hide(); }).catch(() => { alert("Ø­Ø¯Ø« Ø®Ø·Ø£."); hideLoading(); }); });
        
        document.addEventListener('DOMContentLoaded', () => { showLoading(); });
    </script>
</body>
</html>
