<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>السوق الرقمي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0d6efd; --secondary-color: #0dcaf0; --bg-main: #f8f9fa; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); --border-radius: 12px; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-main); padding-bottom: 80px; }
        .main-content, .auth-container { display: none; }
        .active-section { display: block; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .auth-container { max-width: 450px; margin: 5rem auto; }
        .page-header { font-weight: 700; color: #333; margin-bottom: 1.5rem; }
        .content-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); border: 1px solid #e9ecef; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: #ffffff; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 1000; border-top: 1px solid #f0f0f0; }
        .nav-item { flex-basis: 0; flex-grow: 1; display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; transition: all 0.3s ease; }
        .nav-item i { font-size: 1.5rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); }
        .card-digital { color: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .card-digital.default-card { background: linear-gradient(to right, #8f94fb, #4e54c8); }
        .card-digital.vip-card { background: linear-gradient(to right, #243B55, #141E30); }
        .card-profile-pic { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); object-fit: cover; }
        .card-username { font-size: 1.8rem; font-weight: 700; margin-top: 15px; }
        #designs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .design-card { background: #fff; border-radius: var(--border-radius); box-shadow: 0 10px 30px var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .design-card:hover { transform: translateY(-10px); }
        .image-container { position: relative; }
        .image-container::after { content: 'PREVIEW'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 2.5rem; font-weight: 900; color: rgba(255, 255, 255, 0.4); pointer-events: none; text-shadow: 0 0 15px rgba(0,0,0,0.6); }
        .design-card img { width: 100%; height: 250px; object-fit: cover; }
        .design-info { padding: 1.5rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .design-price { color: var(--primary-color); font-size: 1.7rem; font-weight: 900; margin-bottom: 1.5rem; }
        #purchase-certificate { border: 2px solid #333; background: #fdfdfd; padding: 1.5rem; color: #000; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 3000; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="auth-section" class="auth-container"><div class="card p-4"><h3 class="text-center mb-4" id="auth-title">تسجيل الدخول</h3><form id="login-form"><div class="mb-3"><label for="login-email" class="form-label">البريد الإلكتروني</label><input type="email" class="form-control" id="login-email" required></div><div class="mb-3"><label for="login-password" class="form-label">كلمة المرور</label><input type="password" class="form-control" id="login-password" required></div><button type="submit" class="btn btn-primary w-100">دخول</button></form><form id="register-form" class="d-none"><div class="mb-3"><label for="register-username" class="form-label">اسم المستخدم</label><input type="text" class="form-control" id="register-username" required></div><div class="mb-3"><label for="register-email" class="form-label">البريد الإلكتروني</label><input type="email" class="form-control" id="register-email" required></div><div class="mb-3"><label for="register-password" class="form-label">كلمة المرور</label><input type="password" class="form-control" id="register-password" minlength="6" required></div><button type="submit" class="btn btn-success w-100">إنشاء حساب</button></form><div id="auth-error" class="alert alert-danger mt-3 d-none"></div><p class="text-center mt-3 mb-0"><a href="#" id="switch-auth-mode">ليس لديك حساب؟ إنشاء حساب جديد</a></p></div></div>
    <div id="main-section" class="main-content">
        <div class="container mt-4">
            <div id="profile" class="page"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="page-header mb-0">الحساب الشخصي</h3><span id="profile-status" class="badge fs-6"></span></div><div class="content-card mb-3"><div class="card-body"><ul class="list-group list-group-flush"><li class="list-group-item"><strong>اسم المستخدم:</strong> <span id="profile-username"></span></li><li class="list-group-item"><strong>UID:</strong> <code id="profile-uid" class="text-muted" title="اضغط للنسخ"></code></li></ul></div></div><div id="vip-section" class="content-card"></div></div>
            <div id="wallet" class="page"><h3 class="page-header">المحفظة</h3><div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title"><i class="bi bi-coin"></i> رصيد الروبل</h5><p class="card-text fs-1 fw-bold" id="wallet-roble">0</p></div></div><div class="row g-2 mb-4"><div class="col-6 d-grid"><button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#sendModal">إرسال</button></div><div class="col-6 d-grid"><button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#requestModal">طلب</button></div><div class="col-6 d-grid"><button class="btn btn-info text-white" type="button" data-bs-toggle="modal" data-bs-target="#depositModal">إيداع</button></div><div class="col-6 d-grid"><button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#withdrawModal">سحب</button></div></div><div class="content-card mb-4"><div class="card-body"><h5 class="card-title">استرداد كود هدية</h5><form id="redeem-code-form" class="d-flex"><input type="text" id="redeem-code-input" class="form-control me-2" placeholder="أدخل الكود هنا" required><button class="btn btn-warning" type="submit">استرداد</button></form></div></div><div class="content-card"><div class="card-header bg-white"><h5><i class="bi bi-list-ul"></i> سجل العمليات</h5></div><div class="card-body p-0"><ul id="transaction-history" class="list-group list-group-flush"></ul></div></div></div>
            <div id="shop" class="page">
                 <div class="d-flex justify-content-between align-items-center">
                    <h3 class="page-header">🎨 متجر التصاميم</h3>
                    <div id="user-info-bar" class="d-inline-flex align-items-center gap-3" style="background: #fff; padding: 0.5rem 1rem; border-radius: 50px; box-shadow: var(--card-shadow);">
                        <span id="shop-username-display"></span>
                        <span id="shop-roble-balance-display" class="badge bg-primary fs-6"></span>
                    </div>
                </div>
                <div id="designs-grid"></div>
            </div>
            <div id="leaderboard" class="page"><h3 class="page-header">🏆 لوحة الصدارة</h3><div class="content-card"><div class="card-body"><ol id="leaderboard-list" class="list-group list-group-numbered"></ol></div></div></div>
            <div id="card" class="page"><h3 class="page-header">البطاقة الرقمية</h3><div id="digital-card-container" class="card-digital default-card mb-3"></div><div class="content-card mb-3"><div class="card-body"><label for="image-upload" class="form-label">تغيير صورة البطاقة</label><input class="form-control" type="file" id="image-upload" accept="image/*"></div></div><button id="download-card-btn" class="btn btn-success w-100"><i class="bi bi-download"></i> تحميل البطاقة كصورة</button></div>
        </div>
        <nav class="bottom-nav"><a href="#" class="nav-item" data-page="profile"><i class="bi bi-person-fill"></i><span>الحساب</span></a><a href="#" class="nav-item" data-page="wallet"><i class="bi bi-wallet-fill"></i><span>المحفظة</span></a><a href="#" class="nav-item" data-page="shop"><i class="bi bi-shop"></i><span>المتجر</span></a><a href="#" class="nav-item" data-page="leaderboard"><i class="bi bi-trophy-fill"></i><span>الصدارة</span></a><a href="#" class="nav-item" data-page="card"><i class="bi bi-credit-card-2-front-fill"></i><span>البطاقة</span></a></nav>
    </div>
    <div class="modal fade" id="sendModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إرسال روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-pills nav-fill mb-3" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-id">عبر ID</button></li><li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-qr">مسح QR</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="pills-id"><form id="send-by-id-form"><div class="mb-3"><label class="form-label">UID المستلم</label><input type="text" class="form-control" id="recipient-uid" required></div><div class="mb-3"><label class="form-label">المبلغ</label><input type="number" class="form-control" id="transfer-amount" min="1" required></div><div class="mb-3"><label class="form-label">ملاحظة (اختياري)</label><input type="text" class="form-control" id="transfer-note" placeholder="مثال: شكراً لك"></div><button type="submit" class="btn btn-primary w-100">تأكيد</button></form></div><div class="tab-pane fade" id="pills-qr"><div id="qr-reader" style="width:100%; border-radius:12px; border:2px dashed #ccc; overflow:hidden;"></div><hr><input type="file" id="qr-file-input" class="d-none" accept="image/*"><label for="qr-file-input" class="btn btn-secondary w-100"><i class="bi bi-image"></i> اختر صورة QR</label></div></div></div></div></div></div>
    <div class="modal fade" id="requestModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">طلب روبل عبر QR</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">المبلغ المطلوب</label><input type="number" class="form-control" id="request-amount" min="1"></div><button id="generate-qr-btn" class="btn btn-primary w-100 mb-3">إنشاء كود</button><div id="qrcode-container" style="display:flex; justify-content:center; align-items:center; padding:1rem; border:1px solid #eee; border-radius:12px; min-height:280px;"><span class="text-muted">سيظهر كود QR هنا</span></div></div></div></div></div>
    <div class="modal fade" id="confirmTransferModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mt-2">هل أنت متأكد من إرسال روبل إلى:</h5><h3 class="mb-1" id="confirm-recipient-name">...</h3><hr><p class="text-muted mb-1">المبلغ</p><p class="fs-3 fw-bold" id="confirm-amount">0</p><p class="text-muted mb-1" id="confirm-tax-label">الضريبة</p><p class="fs-5" id="confirm-tax-amount">0</p><p class="text-muted mb-1">الإجمالي المخصوم</p><p class="fs-4 fw-bold" id="confirm-total-deducted">0</p><div class="my-3"><label class="form-label">إضافة ملاحظة (اختياري)</label><input type="text" class="form-control" id="confirmation-note"></div><div class="d-grid gap-2 mt-4"><button type="button" class="btn btn-primary btn-lg" id="confirm-transfer-btn">نعم، أوافق</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">رفض</button></div></div></div></div></div>
    <div class="modal fade" id="withdrawModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">طلب سحب روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="withdraw-step-1" class="process-step"><div class="mb-3"><label for="withdraw-amount" class="form-label">المبلغ المراد سحبه</label><input type="number" class="form-control" id="withdraw-amount" min="1"></div><div class="mb-3"><label class="form-label">السحب مقابل</label><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeGold" value="gold" checked><label class="form-check-label" for="typeGold">غولد</label></div><div class="form-check"><input class="form-check-input" type="radio" name="withdrawType" id="typeBank" value="bank"><label class="form-check-label" for="typeBank">أموال حقيقية</label></div></div><button id="withdraw-next-btn" class="btn btn-primary w-100">التالي</button></div><div id="withdraw-step-2" class="process-step"><div id="bank-card-input-group" class="mb-3 d-none"><label for="user-bank-card" class="form-label">أدخل رقم بطاقتك لاستلام المبلغ</label><input type="text" class="form-control" id="user-bank-card"></div><button id="generate-certificate-btn" class="btn btn-success w-100">إنشاء شهادة الطلب</button></div><div id="withdraw-step-3" class="process-step"><div id="certificate" class="mb-3"></div><p class="text-center fw-bold">قم بتحميل هذه الشهادة وأرسلها للمسؤول.</p><button id="download-certificate-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> تحميل الشهادة</button></div></div></div></div></div>
    <div class="modal fade" id="depositModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">فاتورة إيداع روبل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="deposit-step-1" class="process-step"><div class="mb-3"><label for="deposit-amount" class="form-label">كم روبل تريد أن تودع؟</label><input type="number" class="form-control" id="deposit-amount" min="1"><small class="text-muted">يرجى مراجعة المسؤول لمعرفة السعر الحالي.</small></div><button id="generate-invoice-btn" class="btn btn-primary w-100">إنشاء فاتورة الإيداع</button></div><div id="deposit-step-2" class="process-step"><div id="deposit-invoice" class="mb-3"></div><p class="text-center fw-bold">حمّل الفاتورة وأرسلها مع إثبات الدفع للمسؤول.</p><button id="download-invoice-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> تحميل الفاتورة</button></div></div></div></div></div>
    <div class="modal fade" id="buyConfirmationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mt-2">تأكيد الشراء</h5><p>هل تريد شراء <strong id="confirm-item-name"></strong>؟</p><p class="fs-4">السعر: <strong id="confirm-item-price" class="text-primary"></strong> روبل</p><p class="text-muted">رصيدك: <span id="confirm-user-balance"></span> روبل</p><div class="d-grid gap-2 mt-4"><button type="button" class="btn btn-primary btn-lg" id="confirm-purchase-btn">شراء</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button></div></div></div></div></div>
    <div class="modal fade" id="purchaseCertificateModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">تم الشراء!</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="purchase-certificate" class="mb-3"></div><p class="text-center fw-bold">أرسل هذه الشهادة للمسؤول.</p><button id="download-purchase-certificate-btn" class="btn btn-info text-white w-100"><i class="bi bi-download"></i> تحميل</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyA9dfAX6QsQb2b5WQcg4x41oBw7UVnGrcA", authDomain: "qdjeizjeheidjd.firebaseapp.com", projectId: "qdjeizjeheidjd", storageBucket: "qdjeizjeheidjd.firebasestorage.app", messagingSenderId: "790923875489", appId: "1:790923875489:web:76ce647204360a15d80ce0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { serverTimestamp, arrayUnion } = firebase.firestore.FieldValue;
        const VIP_COST = 50, TAX_ACCOUNT_UID = 'E6TOBVW6QTEC', NORMAL_USER_TAX_RATE = 0.05, VIP_USER_TAX_RATE = 0.02, ADMIN_BANK_CARD = 'A020A';
        let unsubscribeUserSnapshot, unsubscribeTransactions, qrScanner, sendModal, requestModal, confirmTransferModal, withdrawModal, depositModal, buyConfirmationModal, purchaseCertificateModal, currentUserData;
        const loadingOverlay = document.getElementById('loading-overlay'), authSection = document.getElementById('auth-section'), mainSection = document.getElementById('main-section');
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        
        const pages = document.querySelectorAll('.page'), navItems = document.querySelectorAll('.nav-item');
        function navigateTo(pageId) {
            pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active');
            navItems.forEach(item => { item.classList.remove('active'); if (item.dataset.page === pageId) item.classList.add('active'); });
            if (pageId === 'leaderboard') loadLeaderboard();
            if (pageId === 'shop') loadDesignsFromFirestore();
        }
        
        auth.onAuthStateChanged(user => {
            if(unsubscribeUserSnapshot) unsubscribeUserSnapshot(); if(unsubscribeTransactions) unsubscribeTransactions();
            if (user) {
                sendModal = new bootstrap.Modal(document.getElementById('sendModal'));
                requestModal = new bootstrap.Modal(document.getElementById('requestModal'));
                confirmTransferModal = new bootstrap.Modal(document.getElementById('confirmTransferModal'));
                withdrawModal = new bootstrap.Modal(document.getElementById('withdrawModal'));
                depositModal = new bootstrap.Modal(document.getElementById('depositModal'));
                buyConfirmationModal = new bootstrap.Modal(document.getElementById('buyConfirmationModal'));
                purchaseCertificateModal = new bootstrap.Modal(document.getElementById('purchaseCertificateModal'));
                mainSection.classList.add('active-section'); authSection.classList.remove('active-section');
                unsubscribeUserSnapshot = db.collection('users').doc(user.uid).onSnapshot(doc => { if (doc.exists) { currentUserData = { uid: user.uid, ...doc.data() }; updateUI(currentUserData); } hideLoading(); }, err => { console.error(err); hideLoading(); });
                listenToTransactions(user.uid);
                navigateTo('profile');
            } else {
                currentUserData = null; mainSection.classList.remove('active-section'); authSection.classList.add('active-section'); hideLoading();
            }
        });

        function listenToTransactions(userId) {
            const historyList = document.getElementById('transaction-history');
            unsubscribeTransactions = db.collection('transactions').where('userId', '==', userId).orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
                if (snapshot.empty) { historyList.innerHTML = `<li class="list-group-item">لا توجد عمليات.</li>`; return; }
                historyList.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const iconMap = { send: 'bi-arrow-up-right text-danger', receive: 'bi-arrow-down-left text-success', vip_purchase: 'bi-patch-check-fill text-warning', redeem: 'bi-gift-fill text-info', tax: 'bi-receipt text-secondary', purchase: 'bi-cart-check-fill text-primary' };
                    const signMap = { send: '-', receive: '+', vip_purchase: '-', redeem: '+', tax: '-', purchase: '-' };
                    const noteHTML = t.note ? `<p class="transaction-note mb-0">"${t.note}"</p>` : '';
                    const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><i class="bi ${iconMap[t.type] || 'bi-info-circle'} me-2"></i>${t.details}${noteHTML}<small class="text-muted d-block">${new Date(t.timestamp?.toDate()).toLocaleString()}</small></div><span class="fw-bold ${t.type === 'receive' || t.type === 'redeem' ? 'text-success' : 'text-danger'}">${signMap[t.type] || ''} ${t.amount}</span>`;
                    historyList.appendChild(li);
                });
            });
        }
        function updateUI(userData) {
            document.getElementById('profile-username').textContent = userData.username;
            const uidEl = document.getElementById('profile-uid'); uidEl.textContent = userData.uid; uidEl.onclick = () => { navigator.clipboard.writeText(userData.uid); alert('تم نسخ الـ UID!'); };
            const statusBadge = document.getElementById('profile-status'); statusBadge.textContent = userData.VIP ? 'عضو VIP' : 'عادي'; statusBadge.className = `badge fs-6 ${userData.VIP ? 'bg-warning text-dark' : 'bg-secondary'}`;
            document.getElementById('wallet-roble').textContent = userData.robleBalance || 0;
            document.getElementById('shop-username-display').textContent = userData.username;
            document.getElementById('shop-roble-balance-display').innerHTML = `<i class="bi bi-coin"></i> ${userData.robleBalance || 0}`;
            const vipSection = document.getElementById('vip-section');
            if(userData.VIP) { vipSection.innerHTML = `<div class="card-body text-center"><h5 class="text-warning">⭐ أنت عضو VIP بالفعل ⭐</h5></div>`; } else { vipSection.innerHTML = `<div class="card-body text-center"><h5>الترقية إلى VIP</h5><p>احصل على ضريبة مخفضة وبطاقة ذهبية!</p><button id="buy-vip-btn" class="btn btn-warning">⭐ ترقية مقابل ${VIP_COST} روبل</button></div>`; document.getElementById('buy-vip-btn').addEventListener('click', purchaseVip); }
            renderDigitalCard(userData.username, userData.uid, userData.robleBalance || 0, userData.VIP);
        }
        function renderDigitalCard(username, uid, roble, isVIP) { const cardContainer = document.getElementById('digital-card-container'); const savedPic = localStorage.getItem('profilePic'); const picHTML = savedPic ? `<img src="${savedPic}" class="card-profile-pic">` : `<div style="font-size: 60px; color: rgba(255,255,255,0.5);"><i class="bi bi-person-circle"></i></div>`; cardContainer.className = `card-digital mb-3 ${isVIP ? 'vip-card' : 'default-card'}`; cardContainer.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div style="font-size:1.2rem;font-weight:bold;">${isVIP ? 'VIP Membership' : 'عضوية مميزة'}</div>${isVIP ? '<span class="badge bg-light text-dark">VIP</span>' : ''}</div>${picHTML}</div><div class="mt-3"><div class="card-username">${username}</div><div class="card-uid">CARD ID: ${uid.substring(0, 12).toUpperCase()}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:25px;text-align:right"><div class="card-balance"><span class="label">روبل</span><span class="amount"><i class="bi bi-coin"></i> ${roble}</span></div><div class="card-balance"><span class="label">غولد</span><span class="amount"><i class="bi bi-gem"></i> ${roble * 2}</span></div></div>`; }
        
        async function loadLeaderboard() { showLoading(); const list = document.getElementById('leaderboard-list'); list.innerHTML = ''; try { const snapshot = await db.collection('users').orderBy('robleBalance', 'desc').limit(10).get(); if (snapshot.empty) { list.innerHTML = `<li class="list-group-item">لا يوجد مستخدمون.</li>`; hideLoading(); return; } snapshot.forEach((doc, index) => { const user = doc.data(); const li = document.createElement('li'); li.className = `list-group-item d-flex justify-content-between align-items-start ${user.uid === auth.currentUser.uid ? 'active' : ''}`; li.innerHTML = `<div class="ms-2 me-auto"><div class="fw-bold">${index+1}. ${user.username}</div></div><span class="badge bg-primary rounded-pill">${user.robleBalance} روبل</span>`; list.appendChild(li); }); } catch (error) { console.error(error); } finally { hideLoading(); } }
        async function loadDesignsFromFirestore() {
            showLoading(); const grid = document.getElementById("designs-grid"); grid.innerHTML = "";
            try {
                const snapshot = await db.collection('shop_items').orderBy('createdAt', 'desc').get();
                if (snapshot.empty) { grid.innerHTML = '<div class="alert alert-info">لا توجد تصاميم في المتجر حاليًا.</div>'; } else {
                    snapshot.forEach(doc => {
                        const design = doc.data(); const div = document.createElement("div"); div.className = "design-card";
                        div.innerHTML = `<div class="image-container"><img src="${design.imageUrl}" alt="${design.name}"></div><div class="design-info"><h3>${design.name}</h3><div class="design-price">${design.price} <span>روبل</span></div><button class="buy-button" onclick='confirmPurchase(${JSON.stringify(design)})'>شراء</button></div>`;
                        grid.appendChild(div);
                    });
                }
            } catch (error) { console.error(error); grid.innerHTML = '<div class="alert alert-danger">حدث خطأ.</div>'; } finally { hideLoading(); }
        }

        function confirmPurchase(design) { if (!currentUserData) return; if ((currentUserData.robleBalance || 0) < design.price) { alert("رصيدك غير كافٍ!"); return; } document.getElementById('confirm-item-name').textContent = design.name; document.getElementById('confirm-item-price').textContent = design.price; document.getElementById('confirm-user-balance').textContent = currentUserData.robleBalance; document.getElementById('confirm-purchase-btn').onclick = () => performPurchase(design); buyConfirmationModal.show(); }
        async function performPurchase(design) {
            buyConfirmationModal.hide(); showLoading();
            const userRef = db.collection('users').doc(currentUserData.uid);
            const itemRef = db.collection('shop_items').doc(design.itemId);
            try {
                await db.runTransaction(async (t) => {
                    const userDoc = await t.get(userRef); const itemDoc = await t.get(itemRef); if (!itemDoc.exists) throw new Error("هذا التصميم تم شراؤه.");
                    const currentBalance = userDoc.data().robleBalance || 0; if (currentBalance < design.price) throw new Error("رصيدك غير كافٍ.");
                    t.update(userRef, { robleBalance: currentBalance - design.price }); t.delete(itemRef);
                    t.set(db.collection('transactions').doc(), { userId: currentUserData.uid, type: 'purchase', amount: design.price, details: `شراء: ${design.name}`, timestamp: serverTimestamp() });
                });
                showCertificate(design.name, `PURCHASE-${Date.now()}`);
            } catch (error) { alert(`فشل: ${error.message}`); loadDesignsFromFirestore(); } finally { hideLoading(); }
        }
        function showCertificate(designName, purchaseId) { document.getElementById('purchase-certificate').innerHTML = `<h4 class="text-center">إثبات شراء</h4><hr><p><strong>رقم الشراء:</strong> ${purchaseId}</p><p><strong>المستخدم:</strong> ${currentUserData.username}</p><p><strong>التصميم:</strong> ${designName}</p>`; purchaseCertificateModal.show(); }
        
        document.addEventListener('DOMContentLoaded', () => {
            showLoading();
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.dataset.page); }));
            document.getElementById('shop-grid').addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON' && e.target.dataset.item) { confirmPurchase(JSON.parse(e.target.dataset.item)); } });
            document.getElementById('download-purchase-certificate-btn').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('purchase-certificate')).then(canvas => { const link = document.createElement('a'); link.download = `purchase-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); hideLoading(); purchaseCertificateModal.hide(); }); });
        });
    </script>
</body>
</html>
